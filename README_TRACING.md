# ?????????????? ??????????? (Distributed Tracing) ? Observability_WebAPI_Blazor

## ?????

??????????? ?????????????? ??????????? ??? ?????????? ????? ????? Blazor Server ? Backend API ? ?????????????? ??????? TraceId.

## ???????????

```
??????? ? Blazor Server ? Backend API
          [TraceId]     [TraceId]
             ?             ?
           Seq/Logs     Seq/Logs
```

## ??? ???? ???????

### 1. Backend (Observability_WebApi_Blazor.Backend)

**????????? ??????:**
- `Serilog.AspNetCore` - ??? ?????????????????? ???????????
- `Serilog.Sinks.Seq` - ??? ???????? ????? ? Seq

**????????? ? Program.cs:**
- ????????? Serilog ? ??????????? TraceId
- ????????? CORS ???????? ??? WebAssembly ???????
- ???????? `UseSerilogRequestLogging` ??? ??????????????? ??????????? HTTP ????????
- ? ?????????? ?????? ???????????? TraceId: `{Timestamp} [{Level}] [{TraceId}] {Message}`

**??????????:**
- ????????? ??????????? ? `WeatherForecastController` ? TraceId

### 2. Blazor Server (Observability_WebAPI_Blazor)

**????????? ? Program.cs:**
- ????????? ???????????? Serilog ? ?????????? TraceId
- ???????? HttpClient ? ?????????????? ????????? trace context
- ????????? `UseSerilogRequestLogging` ??? ??????????? ????????

### 3. WebAssembly Client (Observability_WebAPI_Blazor.Client)

**????????? ??????:**
- `Microsoft.Extensions.Http` - ??? IHttpClientFactory

**????? ????: TraceContextHandler.cs**
- DelegatingHandler ??? ?????????????? ???????? W3C Trace Context headers (`traceparent`, `tracestate`)

**????????? ? Program.cs:**
- ???????? IHttpClientFactory ? TraceContextHandler
- HttpClient ?????? ????????????? ???????? trace context ? Backend

### 4. Blazor UI (Weather.razor)

**?????????:**
- ????????? ?????? ???????? Backend API ?????? ????????? ?????? ????????
- ????????? ??????????? ??????? API
- ???????? fallback ?? ????????? ?????? ??? ??????

## ????????????

### appsettings.json ??? Backend

```json
{
  "Seq": {
    "Url": "http://localhost:5341"
  },
  "AllowedHosts": "*"
}
```

### appsettings.json ??? Blazor Server

```json
{
  "Seq": {
    "Url": "http://localhost:5341"
  },
  "BackendUrl": "https://localhost:7001"
}
```

### appsettings.json ??? WebAssembly Client

```json
{
  "BackendUrl": "https://localhost:7001"
}
```

## ??? ????????

1. **??????? ?????????? ??????** ? Blazor Server ??????? Activity ? TraceId
2. **Blazor Server ????????** ? Serilog ?????????? ??????? ? TraceId ? Seq
3. **HttpClient ?????????? ??????** ? TraceContextHandler ????????? header `traceparent` ? TraceId
4. **Backend ???????? ??????** ? ASP.NET Core ????????????? ????????? TraceId ?? header
5. **Backend ????????** ? Serilog ?????????? ??????? ? ??? ?? TraceId ? Seq
6. **? Seq** ? ????? ??????????? ???? ?? TraceId ? ?????? ???? ???? ???????

## ?????? ????? ? Seq

### Blazor Server
```
09:15:30 [INF] [00-abc123def456-789-00] Calling backend API to get weather forecast
```

### Backend
```
09:15:31 [INF] [00-abc123def456-789-00] Getting weather forecast. TraceId: 00-abc123def456-789-00
```

???????? ????????: **TraceId ??????????** (`00-abc123def456-789-00`), ??? ????????? ????????????? ????!

## ???????? W3C Trace Context

???????????? ???????? W3C Trace Context (https://www.w3.org/TR/trace-context/):
- **traceparent header**: `00-{trace-id}-{parent-id}-{trace-flags}`
- **tracestate header**: vendor-specific context

## ?????? Seq (Docker)

```bash
docker run --name seq -d --restart unless-stopped -e ACCEPT_EULA=Y -p 5341:80 datalust/seq:latest
```

???????? Seq UI: http://localhost:5341

## ????? ? Seq

????? ??? ??????? ??? ??????????? TraceId:
```
TraceId = '00-abc123def456-789-00'
```

????? ??????? ????????:
```
Application = 'Blazor-Server' OR Application = 'Backend'
```

## ?????????????? ??????????

- ASP.NET Core ????????????? ???????????? W3C Trace Context ??????? ? ?????? 5.0
- `Activity.Current` ???????? ??????? trace ??????????
- `HttpContext.TraceIdentifier` ???????? TraceId ???????? HTTP ???????
